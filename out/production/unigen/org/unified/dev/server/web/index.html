<!DOCTYPE html>
<html lang='en'>
<head>
	<title>Unified Dev Server</title>
	<meta http-equiv='Content-Type' content='text/html; charset=utf8'/>
</head>

<script language=javascript>

var socket = new WebSocket('ws://localhost:8080/events')
var server_state = {}

socket.onopen = function() {
	socket.send('client-info`' + navigator.sayswho)
	socket.send('get-state')
}

socket.onclose = function(event) {
}

socket.onmessage = function(event) {
	var parts = event.data.split('`')
	switch (parts[0]) {
		case 'state-changed':
			socket.send('get-state')
			break
		case 'state':
			server_state = JSON.parse(parts[1])
			reflect_server_state()
			break
	}
}

socket.onerror = function(error) {
}

function reflect_sources(container_id, filter) {
	document.getElementById(container_id).innerHTML = server_state.sources.
		filter(filter).
		map(function(source) {
			var html = ['<div class=source-name>', source.name, '</div>']
			html.push('<div class=source-path>', source.path, '</div>')
			if (source.status) {
				html.push(
					'<div class=source-status-' + source.status_class + '>', 
					source.status,
					'&nbsp;<span class=source-status-time>at ', source.status_time, '</span>',
					'</div>')
				if (source.status_details) {
					html.push('<pre class=source-status-details>', source.status_details, '</pre>')
				}
			}
			return html.join('')
		})
}

function reflect_server_state() {
	reflect_sources('repositories', function(source) { return !source.is_module})
	reflect_sources('modules', function(source) { return source.is_module})

	document.getElementById('connections').innerHTML = server_state.connections.
		map(function(connection) {
			return '<div class=source-name>' + connection.client_info +'</div>'
		}).join('')
}

navigator.sayswho= (function(){
    var ua= navigator.userAgent, tem,
    M= ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
    if(/trident/i.test(M[1])){
        tem=  /\brv[ :]+(\d+)/g.exec(ua) || [];
        return 'IE '+(tem[1] || '');
    }
    if(M[1]=== 'Chrome'){
        tem= ua.match(/\b(OPR|Edge)\/(\d+)/);
        if(tem!= null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
    }
    M= M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
    if((tem= ua.match(/version\/(\d+)/i))!= null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();

</script>

<style>
	body {
		margin: 0
	}
	.header {
		background: orange; 
		padding: 8pt 18pt 8pt; 
		font-family: Helvetica Neue, Helvetica; 
		font-size: 24pt; 
		color: white;
	}
	.section-title {
		font-family: Helvetica Neue, Helvetica; 
		font-size: 18pt;
		padding-bottom: 12pt;
		color: orange;
	}
	.source-name {
		font-family: Helvetica Neue, Helvetica; 
		font-size: 18pt;
		color: gray;
	}
	.source-path {
		font-family: Helvetica Neue, Helvetica; 
		font-size: 8pt;
		padding-top: 2pt;
		padding-bottom: 2pt;
		color: silver;
	}
	.source-status-ok {
		font-family: Helvetica Neue, Helvetica; 
		font-size: 12pt;
		color: mediumseagreen;
	}
	.source-status-failed {
		font-family: Helvetica Neue, Helvetica; 
		font-size: 12pt;
		color: tomato;
	}
	.source-status-info {
		font-family: Helvetica Neue, Helvetica; 
		font-size: 12pt;
		color: CornflowerBlue;
	}
	.source-status-details {
		border-radius: 3pt;
		margin-top: 4pt;
		padding: 4pt;
		font-size: 10pt;
		color: brown;
		background: pink;
	}
	.source-status-time {
		font-family: Helvetica Neue, Helvetica; 
		font-size: 11pt;
		color: lightgrey;
	}
	table.sections {
	}
	table.sections td {
		border-left: 3pt solid whitesmoke;
		padding-left: 16pt;
		padding-right: 16pt;
	}

	table.sections td.first {
		border-left: none;
		padding-left: 0;
	}

	div.content {
		padding: 18pt;
	}

	#log {
		font-family: courier;
		font-size: 8pt;
		color: gray;
		height: 100pt;
		overflow: auto;
		padding: 8pt;
		height: 100pt;
		background: whitesmoke;
		position: fixed;
		bottom: 0px;
		width: 100%;
	}

</style>
<body>
<div class='header'>Unified Dev Server</div>

<div class=content>
	<table class=sections>
		<tr>
			<td valign=top class=first>
				<div class=section-title>Modules</div>
				<div id=modules></div>
			</td>
			<td valign=top>
				<div class=section-title>Repositories</div>
				<div id=repositories></div>
			</td>
			<td valign=top>
				<div class=section-title>Connections</div>
				<div id=connections></div>
			</td>
		</tr>
	</table>
</div>

<div id=log>
</div>

</body>
</html>